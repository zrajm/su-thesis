%%
%% FIXME: SU logo should be loaded relative to .sty file's path
%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Template for Bachelor's, Magister and Master's theses at the Department of
%% Linguistics, Stockholm University
%%
%% Modelled on Studentuppsatsmall at https://www.su.se/biblioteket/
%%
%% Version 1.2 by zrajm, 23 February 2020
%% Version 1.1 by zrajm, 22 February 2020
%% Version 1 by Mats Wirén, 12 February 2020
%% Version by Adam Ek & Elena Moser, 19 February 2019
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Projektstruktur
%% /
%% ├── su-template.sty
%% └── /media/
%%     ├── su-logga-sv.png
%%     └── su-logo-en.png
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Denna uppsatsmall inkluderar:
%%
%%   * Titelsida
%%   * Sida med abstract/sammanfattning
%%   * Innehållsförteckning
%%   * Baksida
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% OBS: I Overleaf, byt kompilator till XeLaTeX
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Configuration
%%
%% To use this template, first set a babel language, then load this package,
%% then set all the relevant values. Like this:
%%
%%     \usepackage[swedish]{babel} % Swedish
%%     \usepackage[UKenglish]{babel} % British English
%%     \usepackage[USenglish]{babel} % American English
%%
%%     \usepackage{su-template}
%%
%%     %% Always used
%%     \suset{author}{Förnamn Efternamn}
%%     \suset{supervisor}{Förnamn1 Efternamn1[, Förnamn2 Efternamn2]}
%%     \suset[swedish]{title}{Titel på svenska}
%%     \suset[english]{title}{Title in English}
%%     \suset[swedish]{abstract}{Sammanfattning på svenska}
%%     \suset[english]{abstract}{Abstract in English}
%%     %% Swedish metadata (only used if language is Swedish)
%%     \suset[swedish]{subtitle}{Svensk undertitel}
%%     \suset[swedish]{keywords}{nyckelord1, nyckelord2, nyckelord3, \ldots}
%%     \suset[swedish]{department}{Institutionen för lingvistik}
%%     \suset[swedish]{thesistype}{Examensarbete 15 hp}
%%     \suset[swedish]{course}{Lingvistik -- kandidatkurs, LIN600}
%%     \suset[swedish]{program}{Kandidatprogrammet i lingvistik 180 hp}
%%     \suset[swedish]{semester}{Vårterminen 2020}
%%     %% English metadata (only used if language is English)
%%     \suset[english]{subtitle}{English Subtitle}
%%     \suset[english]{keywords}{keyword1, keyword2, keyword3, \ldots}
%%     \suset[english]{department}{Department of Linguistics}
%%     \suset[english]{thesistype}{Bachelor's Thesis 15 ECTS credits}
%%     \suset[english]{course}{Linguistics -- Bachelor's Course, LIN600}
%%     \suset[english]{program}{Bachelor's Programme in Linguistics 180 ECTS credits}
%%     \suset[english]{semester}{Spring semester 2020}
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Support for Swedish characters (and other Unicode characters).
%% [https://tex.stackexchange.com/questions/664/]
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Use " for quotes. [https://tex.stackexchange.com/questions/386695/]
%%
%% The csquotes package also allows for language-sensitive quotes, and quotes
%% inside quotes etc. For full specs see csquotes docs:
%% http://ftp.acc.umu.se/mirror/CTAN/macros/latex/contrib/csquotes/csquotes.pdf
\usepackage[autostyle=true]{csquotes}
\MakeOuterQuote{"}

%% Needed for \IfSubStr.
\usepackage{xstring}

%% Stockholm university's official colors.
\usepackage{xcolor} % https://ctan.org/pkg/xcolor
\definecolor{sublue}{HTML}{002F5F}
\definecolor{suolive}{HTML}{A3A86B}
\definecolor{susky}{HTML}{ACDEE6}
\definecolor{suwater}{HTML}{9BB2CE}
\definecolor{sufire}{HTML}{D95E00}

%% http://mirrors.ctan.org/macros/latex/contrib/geometry/geometry.pdf
\usepackage[paper=a4paper,left=25mm,right=25mm,top=27.25mm,bottom=25mm]{geometry}
%\usepackage{showframe} % DEBUG: display margins
%\typeout{...}%         % DEBUG: write stuff on stdout during compilation

\newcommand{\TODO}[1]{\marginpar{\texthl{#1}}}

%\usepackage{graphicx}
%\usepackage{url}
%\usepackage{hyperref}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Define font sizes and margins around headings/paragraphs etc.
%%
%% LaTeX size scale
%% ----------------
%% \Huge
%% \huge
%% \LARGE                -- default för \title{} (i \maketitle)
%% \Large                -- default för \section{}
%% \large                -- default för \subsection{}, \author{}/\date{} (i \maketitle)
%% \normalsize (default) -- default för brödtext, \subsubsection{}
%% \small
%% \footnotesize         -- default för footnote{}
%% \scriptsize
%% \tiny

%% |------|---------------|-------------------------------|
%% | 28pt | \LARGE        | titel sidan 1                 | \title{} (FIXME)
%% |------|---------------|-------------------------------|
%% | 26pt | \Large*       | titel sidan 2; rubrik;        | \section{}
%% |      |               | onumrerad rubrik              |
%% |      |               | (innehåll, sammanfattning,    |
%% |      |               | referenser)                   |
%% |------|---------------|-------------------------------|
%% | 16pt | \large*       | underrubrik                   | \subsection{}
%% |------|---------------|-------------------------------|
%% | 14pt | \subtitlesize | undertitel sidan 1            |
%% |------|---------------|-------------------------------|
%% | 11pt | \normalsize*  | brödtext; undertitel sidan 2; | \subsubsection{}
%% |      |               | under-underrubrik; onumrerad  |
%% |      |               | under|under (nyckelord); text |
%% |      |               | i innehållsförteckning        |
%% |------|---------------|-------------------------------|
%% |  8pt | \small        | textruta                      |
%% |------|---------------|-------------------------------|
%% |  6pt | \tiny         | (not used by template)        |
%% |------|---------------|-------------------------------|
%%
%% * = default for LaTeX

%% Add blank space between paragraphs & remove paragraph indent.
%% (With the old version of this package installed on my system parskip is
%% always set to (\baselineskip * .5 + 2pt) which works well enough.)
\usepackage{parskip} % https://ctan.org/pkg/parskip

%% %% DEBUG: Use this to set length between paragraphs.
%% \newcommand{\loadparskip}[1]{
%%   \newlength{\lengthNewParskip}
%%   \deflength{\lengthNewParskip}{(#1 * 2) -4pt}
%%   \newlength{\lengthOrgBaselineskip}
%%   \deflength{\lengthOrgBaselineskip}{\baselineskip}
%%   \baselineskip=\lengthNewParskip
%%   \usepackage{parskip} % https://ctan.org/pkg/parskip
%%   \baselineskip=\lengthOrgBaselineskip
%% }
%% \loadparskip{8pt}

%% FIXME line height! (Currently rounded off fontsize * 1.2).
\renewcommand\LARGE{\@setfontsize\LARGE{28pt}{34pt}}
\renewcommand\Large{\@setfontsize\Large{26pt}{31pt}}
\renewcommand\large{\@setfontsize\large{16pt}{19pt}}
\newcommand\subtitlesize{\@setfontsize\subtitlesize{14pt}{16.8pt}}
\renewcommand\small{\@setfontsize\small{8pt}{9pt}}
\renewcommand\tiny{\@setfontsize\tiny{6pt}{7.2pt}}

%% Set default fonts.
%% http://ftp.acc.umu.se/mirror/CTAN/macros/latex/contrib/fontspec/fontspec.pdf
\usepackage{fontspec}
\setmainfont[Ligatures=TeX]{Times New Roman}
\setsansfont[Ligatures=TeX,WordSpace=.95,LetterSpace=1]{Verdana}
% \setmainfont{Doulos SIL} % contains IPA (see https://software.sil.org/doulos/)
% \setmainfont{Linux Libertine O} % contains IPA

%% Set section heading font and size.
%% http://ftp.acc.umu.se/mirror/CTAN/macros/latex/contrib/titlesec/titlesec.pdf
\usepackage{titlesec}
\titleformat*{\section      }{\sffamily\raggedright\Large}
\titleformat*{\subsection   }{\sffamily\raggedright\bfseries\large}
\titleformat*{\subsubsection}{\sffamily\raggedright\bfseries\normalsize}

%% This length is needed elsewhere too.
\newlength{\lengthBelowSection}
\deflength{\lengthBelowSection}{24pt}

\titlespacing*{\section      }{0pt}{36pt}{\lengthBelowSection}
\titlespacing*{\subsection   }{0pt}{24pt}{ 6pt}
\titlespacing*{\subsubsection}{0pt}{12pt}{ 6pt}

% For 'keyword' heading on abstract page.
% (A \subsubsection with doubled space above.)
\newcommand{\keywordsection}[1]{%
    \vspace{12pt}

    \subsubsection*{#1}
    \vspace{-6pt}
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% CITATION FORMATS
%%
%% When 'apacite' package is loaded with 'natbibapa', then citation commands
%% from the 'natbib' packackage is used in the text.
%%
%% Use (AVOID USING \cite{...}):
%%     \citep{...} -- parenthetical citation like '(Bergman & Wallin, 2001)'
%%     \citet{...} -- textual citation like 'Bergman och Wallin (2001)'
%%
%% Args can include multiple sources:
%%     \citep{src1,src2}
%%     \citet{src1,src2}
%%
%% Optional args:
%%     \citep[][13--14]{jon90}
%%     \citep[see][]{jon90}
%%     \citep[see][chap.~2]{jon90}
%%
%% \shortcite{...} produces a citation like '(1999)'
%% \newcite{...}   produces a citation like 'Author (1999)'
%%
%% All three take an optional argument which can be used to add page
%% references, etc.:
%% "\newcite[1--6]{...}" produces a citation like "Author (1999, 1--6)"
%%
%% Use 'apacite' for references.
\usepackage[natbibapa]{apacite} % https://ctan.org/pkg/apacite & https://ctan.org/pkg/natbib
\bibliographystyle{apacite}
\setcitestyle{notesep={:}}                     % : between year arg page number
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Printed uncited references are in gray in references section.
%%
%% (This is a hack that most likely will only work with 'natbib'. It's based on
%% this https://tex.stackexchange.com/questions/212515/)
%%
\csletcs{orgcitation}{citation}
\csletcs{orgbibitem}{bibitem}
\newcommand*{\eachcite}[1]{%                   % remember each citation used
  \global\csdef{ZZ#1}{}%
}
\csdef{citation}#1{%                           % split \citeX argument on comma
  \forcsvlist{\eachcite}{#1}%
  \orgcitation{#1}%
}
\renewcommand{\bibitem}[2][]{%                 % set text color for bibitem
  \color{black}%
  \ifcsundef{ZZ#2}{%
    \typeout{FIXME: MISSING CITATION FOR '#2'}%
    \color{gray}%
  }{}%
  \orgbibitem[#1]{#2}%
}%
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% This gives capability for prettier tables.
%%   \midrule, \bottomrule, \toprule is from booktabs.
%%   'L' and 'C' can be used in column specifications of tabularx.
%%
\usepackage{tabularx}  % https://ctan.org/pkg/tabularx
\usepackage{booktabs}  % https://ctan.org/pkg/booktabs
\newcolumntype{C}{>{\centering\arraybackslash}X}   % centered 'X' column
\newcolumntype{L}{>{\raggedright\arraybackslash}X} % left aligned 'X' column
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Slew of random stuff

%\usepackage{libertine}
%\usepackage{libertinust1math}
%\setmonofont[Scale=0.76]{Bitstream Vera Sans Mono} % typewriter font and scaling

\usepackage{amsmath}

% \usepackage[capitalize,noabbrev]{cleveref}
% \usepackage[capitalize,noabbrev]{cleveref}

% Create normal/logarithmic plots in two and three dimensions
% \usepackage{pgfplots}

% \usepackage{filecontents}
\usepackage[title]{appendix}

% Define footnotecolor
\makeatletter
\def\@footnotecolor{red}
\define@key{Hyp}{footnotecolor}{%
 \HyColor@HyperrefColor{#1}\@footnotecolor%
}
\def\@footnotemark{
    \leavevmode
    \ifhmode\edef\@x@sf{\the\spacefactor}\nobreak\fi
    \stepcounter{Hfootnote}%
    \global\let\Hy@saved@currentHref\@currentHref
    \hyper@makecurrent{Hfootnote}%
    \global\let\Hy@footnote@currentHref\@currentHref
    \global\let\@currentHref\Hy@saved@currentHref
    \hyper@linkstart{footnote}{\Hy@footnote@currentHref}%
    \@makefnmark
    \hyper@linkend
    \ifhmode\spacefactor\@x@sf\fi
    \relax
  }
\makeatother

%% http://ftp.acc.umu.se/mirror/CTAN/macros/latex/contrib/hyperref/doc/manual.pdf
\usepackage{hyperref}
% Hyperlänkar för citeringar omfattar bara år. Ska tydligen vara så: https://latex.org/forum/viewtopic.php?t=25341

% Examples & Glossaries
%\usepackage{expex} % for examples
%\usepackage{glossaries}

\usepackage{tikz}
\usetikzlibrary{shapes.geometric, arrows, positioning}

\usepackage{soulutf8} % Highlighting with \hl{} and utf-8

\usepackage{multirow}

%% http://ftp.acc.umu.se/mirror/CTAN/macros/latex/contrib/etoolbox/etoolbox.pdf
\usepackage{etoolbox}

%% Commands which set/get variables named \su<LANG><NAME>.
\newcommand{\suset}[3][english]{%
  \csdef{su#1#2}{#3}%
  \iflanguage{swedish}{%
    \ifstrequal{#1#2}{swedishtitle}{\hypersetup{pdftitle=#3}}{}%
    %\ifstrequal{#1#2}{swedishkeywords}{\hypersetup{pdfkeywords=#3}}{}%
  }{%
    \ifstrequal{#1#2}{englishtitle}{\hypersetup{pdftitle=#3}}{}%
    %\ifstrequal{#1#2}{englishkeywords}{\hypersetup{pdfkeywords=#3}}{}%
  }%
  \ifstrequal{#2}{author}{\hypersetup{pdfauthor=#3}}{}%
}
\newcommand{\suget}[2][english]{%
  \ifcsdef{su#1#2}{%
    \csuse{su#1#2}%
  }{%
    \hl{Add \texttt{\textbackslash{}suset[#1]\{#2\}\{...\}}}%
  }%
}

% Subtitle on front page.
\newcommand{\susubtitle}[2][english]{
  \ifcsdef{su#1#2}{%
    \vspace{12pt}

    \noindent\suget[#1]{#2}%
  }{}
}

% Subtitle on abstract page.
\newcommand{\susubtitlex}[2][english]{%
  \ifcsdef{su#1#2}{%
    %% Remove space under \section{}.
    \newlength{\lengthRemoveMargin}%
    \deflength{\lengthRemoveMargin}{0pt - \lengthBelowSection}%
    \vspace{\lengthRemoveMargin}

    \subsubsection*{\suget[#1]{#2}}

    %% And add that space below the subtitle instead.
    \vspace{\lengthBelowSection}
  }{}
}

\newcommand{\sumakefrontpage}{%
  {%
    \color{sublue}%
    \sffamily

    \noindent{%
      \raggedright%
      \LARGE%
      \iflanguage{swedish}{%
        \suget[swedish]{title}%
      }{%
        \suget[english]{title}%
      }%
      \par%
    }

    {%
      \subtitlesize%
      \iflanguage{swedish}{%
        \susubtitle[swedish]{subtitle}%
      }{%
        \susubtitle[english]{subtitle}%
      }

      \vspace{33pt}

      \noindent%
      \suget{author}%
    }

    \vspace{\fill}

    \begin{small}
      \noindent
      \iflanguage{swedish}{%
        \suget[swedish]{department} \\
        \suget[swedish]{thesistype} \\
        \suget[swedish]{course} \\
        \suget[swedish]{program} \\
        \suget[swedish]{semester} \\
        Handledare: \suget{supervisor} \\
        English title: \suget[english]{title}
      }{%
        \suget[english]{department} \\
        \suget[english]{thesistype} \\
        \suget[english]{course} \\
        \suget[english]{program} \\
        \suget[english]{semester} \\
        Supervisor\IfSubStr{\suenglishsupervisor}{,}{s}{}: \suget{supervisor} \\
        Swedish title: \suget[swedish]{title}
      }
    \end{small}

    \vspace{-2.5em}%

    \hspace{\stretch 1}\ \kern\textwidth\kern-50mm\smash{%
      \raisebox{-3mm}{%
        \iflanguage{swedish}{%
          \includegraphics[width=41mm]{su-logga-sv.png}%
        }{%
          \includegraphics[width=41mm]{su-logo-en.png}%
        }%
      }%
    }
    %\renewcommand{\contentsname}{Table of Contents} % Uncomment to change the title of table of contents page to what is written in {Table of Contents}.
    \pagenumbering{gobble} % Switch off page numbering in table of contents
  }%
}

\newcommand{\sumakeabstractpage}{
  \noindent%
  \iflanguage{swedish}{%
    \section*{\suget[swedish]{title}}%
  }{%
    \section*{\suget[english]{title}}%
  }%

  \iflanguage{swedish}{%
    \susubtitlex[swedish]{subtitle}%
  }{%
    \susubtitlex[english]{subtitle}%
  }

  \subsubsection*{\suget{author}}
  \vspace{\lengthBelowSection}

  \iflanguage{swedish}{%
    \section*{Sammanfattning}
    \suget[swedish]{abstract}

    \keywordsection{Nyckelord}
    \suget[swedish]{keywords}

    \section*{Abstract}
    \suget[english]{abstract}

    \keywordsection{Keywords}
    \suget[english]{keywords}
  }{%
    \section*{Abstract}
    \suget[english]{abstract}
    \keywordsection{Keywords}
    \suget[english]{keywords}

    \section*{Sammanfattning}
    \suget[swedish]{abstract}
    \keywordsection{Nyckelord}
    \suget[swedish]{keywords}
  }
}

\newcommand{\sutableofcontents}{%
  {%
    \sffamily%
    \tableofcontents%
  }%
}

\newcommand{\sumakebackpage}{%
  {%
    \color{sublue}%
    \sffamily

    \vspace*{\fill}

    \begin{small}
      \noindent
      \iflanguage{swedish}{%
        Stockholms universitet \\
        106\,91 Stockholm \\
        Telefon 08-16\,20\,00 \\
        \texttt{https://www.su.se/}
      }{%
        Stockholm University \\
        SE-106\,91 Stockholm, Sweden \\
        Telephone +46 (0)8\,16\,20\,00 \\
        \texttt{https://www.su.se/}
      }
    \end{small}

    \vspace*{-1em}

    \hspace{\stretch 1}\ \kern\textwidth\kern-50mm\smash{%
      \raisebox{-3mm}{%
        \iflanguage{swedish}{%
          \includegraphics[width=41mm]{su-logga-sv.png}%
        }{%
          \includegraphics[width=41mm]{su-logo-en.png}%
        }%
      }%
    }%
  }%
}

\AtBeginDocument{
  \sumakefrontpage
  \clearpage

  \sumakeabstractpage
  \clearpage

  \sutableofcontents
  \clearpage

  \pagenumbering{arabic} % start page numbering
}

\AtEndDocument{
  \pagenumbering{gobble} % turn off page numbering
  \sumakebackpage
  \clearpage
}

%% [eof]
